#pragma once
#include "engine_compat.h"
#include <ibus.h>

static g::Pointer<IBusFactory> factory = NULL;

namespace lemonade::ibus {
class Application {
public:
  Application(gboolean ibus) {
    ibus_init();

    bus = ibus_bus_new();
    g_object_ref_sink(bus);

    auto callback = +[](IBusBus *bus, gpointer user_data) { ibus_quit(); };
    g_signal_connect(bus, "disconnected", G_CALLBACK(callback), NULL);

    factory = ibus_factory_new(ibus_bus_get_connection(bus));

    ibus_factory_add_engine(factory, "@IBUS_ENGINE_NAME@",
                            IBUS_TYPE_LEMONADE_ENGINE);

    if (ibus) {
      ibus_bus_request_name(bus, "@IBUS_BUS_NAME@", 0);
    } else {

      g::Pointer<IBusComponent> component;

      component = ibus_component_new(
          /*name=*/"@IBUS_BUS_NAME@", /*description=*/"@PROJECT_DESCRIPTION@",
          /*version=*/"@PROJECT_VERSION@", /*license=*/"@PROJECT_LICENSE@",
          /*uthor=*/"@PROJECT_AUTHOR@",
          /*homepage=*/"@PROJECT_HOMEPAGE@",
          /*commandline=*/"", /*textdomain=*/"@IBUS_TEXTDOMAIN@");
      ibus_component_add_engine(component,
                                ibus_engine_desc_new(
                                    /*shortname=*/"@PROJECT_SHORTNAME@",
                                    /*longname=*/"@PROJECT_LONGNAME@",
                                    /*description=*/"@PROJECT_DESCRIPTION@",
                                    /*language=*/"@IBUS_LANGUAGE@",
                                    /*license=*/"@PROJECT_LICENSE@",
                                    /*author=*/"@AUTHOR@",
                                    /*icon=*/"@IBUS_ICON@",
                                    /*layout=*/"@IBUS_LAYOUT@"));
      ibus_bus_register_component(bus, component);
    }
  }

private:
  IBusBus *bus = NULL;
};
} // namespace lemonade::ibus
